name: Daily EDINET Extract

on:
  schedule:
    - cron: '0 15 * * *'  # 毎日日本時間 0:00 (UTC 15:00)
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Start Date (YYYY-MM-DD)'
        required: true
        default: '2024-06-01'
      end_date:
        description: 'End Date (YYYY-MM-DD)'
        required: true
        default: '2024-06-30'

jobs:
  discovery:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Lint and Format with Ruff
        run: |
          ruff format .
          ruff check --fix .
      - id: set-matrix
        env:
          EDINET_API_KEY: ${{ secrets.EDINET_API_KEY }}
          EXTRACT_START: ${{ github.event.inputs.start_date || '2024-06-01' }}
          EXTRACT_END: ${{ github.event.inputs.end_date || '2024-06-30' }}
          DISABLE_PANDERA_IMPORT_WARNING: True
        run: |
          # 30日前から今日までの期間を自動計算
          START_DATE=$(date -d "30 days ago" +%Y-%m-%d)
          END_DATE=$(date +%Y-%m-%d)
          
          # 手動入力がある場合はそちらを優先
          [[ -n "${{ github.event.inputs.start_date }}" ]] && START_DATE="${{ github.event.inputs.start_date }}"
          [[ -n "${{ github.event.inputs.end_date }}" ]] && END_DATE="${{ github.event.inputs.end_date }}"
          
          # マーカー（JSON_MATRIX_DATA:）を目印に JSON を取得
          RAW_JSON=$(python main.py --list-only --start "$START_DATE" --end "$END_DATE" | grep "^JSON_MATRIX_DATA:" | cut -d':' -f2-)
          DATA=${RAW_JSON:-"[]"}
          
          # 業種衝突を防ぎつつ均等分割するロジック
          echo "$DATA" | python -c "
          import json, math, sys
          try:
              # 標準入力から JSON を読み込む
              data_raw = sys.stdin.read()
              data = json.loads(data_raw)
              if not data:
                  sys.stderr.write('\n' + '#' * 60 + '\n')
                  sys.stderr.write('  EDINET 抽出レポート: 書類が 0 件のため終了します\n')
                  sys.stderr.write('#' * 60 + '\n\n')
                  print('matrix=[]')
                  sys.exit(0)
              
              sec_map = {}
              for item in data:
                  s = item['sector']
                  sec_map.setdefault(s, []).append(item['id'])
              
              sorted_sectors = sorted(sec_map.keys(), key=lambda x: len(sec_map[x]), reverse=True)
              n, buckets, bucket_counts = 4, [[] for _ in range(4)], [0] * 4
              res_meta = [{} for _ in range(4)]
              
              for s in sorted_sectors:
                  idx = bucket_counts.index(min(bucket_counts))
                  buckets[idx].extend(sec_map[s])
                  bucket_counts[idx] += len(sec_map[s])
                  # セクター名をバケットごとに追加記録
                  if 'sectors' not in res_meta[idx]: res_meta[idx]['sectors'] = []
                  res_meta[idx]['sectors'].append(s)
              
              res = []
              for i, b in enumerate(buckets):
                  if not b: continue
                  sectors_str = \", \".join(res_meta[i]['sectors'])
                  # 表示用に短縮 (長すぎる場合は末尾を...)
                  display_sectors = (sectors_str[:50] + '...') if len(sectors_str) > 50 else sectors_str
                  res.append({
                      'ids': ','.join(b),
                      'idx': i,
                      'count': len(b),
                      'sectors': display_sectors
                  })
              
              # レポート出力
              sys.stderr.write('\n' + '#' * 60 + '\n')
              sys.stderr.write('  EDINET 書類取得・ジョブ分割 レポート\n')
              sys.stderr.write('#' * 60 + '\n')
              sys.stderr.write(f'対象期間内の書類総数: {len(data)} 件\n')
              sys.stderr.write(f'分割ジョブ数: {len(res)}\n\n')
              for r in res:
                  sys.stderr.write(f'  - Job {r[\"idx\"]}: {r[\"count\"]} 件を担当 ({r[\"sectors\"]})\n')
              sys.stderr.write('#' * 60 + '\n\n')
  
              # 結果をGitHub Outputへ
              print(f'matrix={json.dumps(res)}')
          except Exception as e:
              import traceback
              sys.stderr.write(f'Error: {traceback.format_exc()}\n')
              print('matrix=[]')
          " >> $GITHUB_OUTPUT

  extract:
    needs: discovery
    if: needs.discovery.outputs.matrix != '[]' && needs.discovery.outputs.matrix != ''
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        chunk: ${{ fromJson(needs.discovery.outputs.matrix) }}
    timeout-minutes: 360
    name: extract (${{ matrix.chunk.sectors }})
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Lint and Format with Ruff
        run: |
          ruff format .
          ruff check --fix .

      - name: Run Extraction
        env:
          EDINET_API_KEY: ${{ secrets.EDINET_API_KEY }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_REPO: ${{ vars.HF_REPO }}
        run: |
          # 30日前から今日までの期間を自動計算（修復用スライディングウィンドウ）
          START_DATE=$(date -d "30 days ago" +%Y-%m-%d)
          END_DATE=$(date +%Y-%m-%d)
          
          # 手動入力がある場合はそちらを優先
          [[ -n "${{ github.event.inputs.start_date }}" ]] && START_DATE="${{ github.event.inputs.start_date }}"
          [[ -n "${{ github.event.inputs.end_date }}" ]] && END_DATE="${{ github.event.inputs.end_date }}"
          
          python main.py --start "$START_DATE" --end "$END_DATE" --id-list "${{ matrix.chunk.ids }}"

      # Commit and Push (Parquet化に伴い廃止)
